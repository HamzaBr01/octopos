<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="OctoPOS - Système de point de vente pour serveurs">
    <title>OctoPOS | Interface Serveur</title>

    <!-- Polices -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root {
            /* Couleurs principales */
            --primary: #2563EB;
            --primary-light: #DBEAFE;
            --primary-dark: #1D4ED8;
            --secondary: #10B981;
            --secondary-light: #D1FAE5;
            --secondary-dark: #059669;
            --danger: #EF4444;
            --warning: #F59E0B;
            --success: #10B981; /* Note: Same as secondary */
            --info: #3B82F6;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --black: #000000;

            /* Mode clair (par défaut) */
            --bg-color: var(--gray-50);
            --card-bg: var(--white);
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);

            /* Mesures */
            --touch-target: 44px; /* Recommended minimum */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Ombres (plus douces) */
            --shadow-sm: 0 2px 4px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 5px 10px -2px rgba(0, 0, 0, 0.06), 0 3px 6px -2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 12px 20px -5px rgba(0, 0, 0, 0.07), 0 5px 10px -3px rgba(0, 0, 0, 0.04);

            /* Transitions */
            --transition-fast: 0.15s ease-out;
            --transition-std: 0.2s ease-in-out;
            --transition-slow: 0.3s ease-in-out;

            /* Z-index */
            --z-header: 10;
            --z-cart: 15;
            --z-modal: 20;
            --z-overlay: 19; /* Below modal */
            --z-toast: 100;
        }

        /* Mode sombre */
        .dark-mode {
            --bg-color: var(--gray-900);
            --card-bg: var(--gray-800);
            --text-color: var(--gray-100);
            --text-muted: var(--gray-400);
            --border-color: var(--gray-700);
        }

        /* Mode contraste élevé */
        .high-contrast {
            --primary: #0047AB;
            --primary-light: #BFDBFE;
            --text-color: var(--black);
            --text-muted: #333333;
            --bg-color: var(--white);
            --border-color: var(--black);
            --card-bg: var(--white);
            --shadow-sm: none; /* Disable shadows for high contrast */
            --shadow-md: none;
            --shadow-lg: none;
            border: 1px solid var(--black); /* Add borders to elements */
        }
        .high-contrast .header,
        .high-contrast .tabs,
        .high-contrast .table-item,
        .high-contrast .menu-item,
        .high-contrast .cart,
        .high-contrast .modal,
        .high-contrast .payment-method,
        .high-contrast .payment-summary,
        .high-contrast .numkey,
        .high-contrast .receipt {
            border: 1px solid var(--black);
            box-shadow: none;
        }
        .high-contrast .table-free,
        .high-contrast .table-occupied,
        .high-contrast .table-reserved {
            border-width: 2px !important; /* Make status borders thicker */
        }

        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; /* Prevent double-tap zoom */
            transition: background-color var(--transition-std), color var(--transition-std);
        }

        /* Accessibility: Focus Outline */
        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
        /* Remove default outline when :focus-visible is supported */
        :focus:not(:focus-visible) {
            outline: none;
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem var(--spacing-md);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            transition: background-color var(--transition-std), border-color var(--transition-std);
        }

        /* === Original Logo Styles START === */
        .logo {
            display: flex;
            align-items: center;
        }
        .logo-icon {
            position: relative; /* Nécessaire pour positionner les enfants */
            margin-right: 0.5rem;
            /* La taille sera définie par les icônes enfants */
        }
        .logo-icon i {
            font-size: 1.5rem; /* Taille de base des icônes */
            display: block; /* Assure que les icônes se superposent correctement */
        }
        .logo-icon i:first-child {
            position: absolute; /* Positionnement absolu par rapport à .logo-icon */
            top: -2px;          /* Décalage vers le haut */
            left: -2px;         /* Décalage vers la gauche */
            color: var(--secondary); /* Couleur de l'icône arrière */
            opacity: 0.3;        /* Opacité pour l'effet d'ombre/arrière-plan */
            z-index: 1;         /* Assure qu'il est derrière (si nécessaire) */
        }
        .logo-icon i:last-child {
            position: relative; /* Reste dans le flux relatif mais au-dessus par défaut */
            color: var(--primary);  /* Couleur de l'icône avant */
            z-index: 2;         /* Assure qu'il est devant */
        }
        .logo-text {
            font-weight: 800;
            font-size: 1.25rem;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        /* === Original Logo Styles END === */

        .header-right { display: flex; align-items: center; gap: var(--spacing-sm); }
        .datetime { font-size: 0.875rem; color: var(--text-muted); white-space: nowrap; }
        .header-buttons { display: flex; align-items: center; }
        .header-button {
            width: var(--touch-target); height: var(--touch-target);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-left: var(--spacing-xs);
            background: transparent; border: none; color: var(--text-muted);
            cursor: pointer; position: relative;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .header-button:hover { background-color: var(--gray-100); color: var(--text-color); }
        .header-button.active { background-color: var(--primary-light); color: var(--primary); }
        .header-button .badge {
            position: absolute; top: 4px; right: 4px;
            background-color: var(--danger); color: var(--white);
            font-size: 0.7rem; font-weight: 600;
            min-width: 18px; height: 18px; border-radius: 9px;
            display: flex; align-items: center; justify-content: center; padding: 0 4px;
        }
        .user-info {
            display: flex; align-items: center;
            padding-left: var(--spacing-sm); margin-left: var(--spacing-sm);
            border-left: 1px solid var(--border-color);
        }
        .avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary)); /* Adjusted gradient */
            color: var(--white);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.875rem;
            margin-right: 0.75rem; flex-shrink: 0;
        }
        .user-details { display: none; } /* Hidden by default */
        @media (min-width: 640px) {
            .user-details { display: block; }
            .user-name { font-weight: 700; font-size: 0.875rem; line-height: 1.25; color: var(--text-color); }
            .user-role { font-size: 0.75rem; color: var(--text-muted); }
        }

        /* Tabs */
        .tabs {
            display: flex; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;
            background-color: var(--card-bg); border-bottom: 1px solid var(--border-color);
            position: sticky; top: 57px; /* Height of header approx */
            z-index: calc(var(--z-header) - 1);
            transition: background-color var(--transition-std), border-color var(--transition-std);
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            padding: 0.75rem 1.25rem; white-space: nowrap; color: var(--text-muted);
            font-weight: 600; font-size: 0.875rem;
            border: none; background: none; /* Treat as button */
            border-bottom: 3px solid transparent; margin-bottom: -1px; /* Overlap border-bottom */
            cursor: pointer;
            transition: color var(--transition-std), border-color var(--transition-std);
            display: flex; align-items: center; gap: var(--spacing-sm);
        }
        .tab:hover { color: var(--text-color); }
        .tab[aria-selected="true"] { color: var(--primary); border-bottom-color: var(--primary); }
        /* .tab i { margin-right: 0.5rem; } */ /* Replaced by gap */

        /* Main Content Area */
        .main-content {
            flex: 1; overflow: hidden; position: relative;
        }
        .tab-content {
            height: 100%; width: 100%; position: absolute;
            top: 0; left: 0;
            /* display: none; Replaced by 'hidden' attribute */
            padding: var(--spacing-md);
            overflow-y: auto; /* Enable scrolling within tab content */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        /* .tab-content.active { display: block; } Replaced by removing 'hidden' */

        /* Table Grid */
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); flex-wrap: wrap; gap: var(--spacing-sm); }
        .view-toggle { display: flex; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; }
        .view-btn {
            padding: 0.5rem 0.75rem; border: none; background: none; color: var(--text-muted); cursor: pointer;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .view-btn:hover { background-color: var(--gray-100); }
        .view-btn.active { background-color: var(--primary); color: var(--white); }
        .status-legend { display: flex; flex-wrap: wrap; gap: var(--spacing-md); align-items: center; }
        .status-item { display: flex; align-items: center; font-size: 0.8rem; color: var(--text-muted); }
        .status-color { width: 0.75rem; height: 0.75rem; border-radius: 50%; margin-right: 0.375rem; }
        .color-free { background-color: var(--success); }
        .color-occupied { background-color: var(--danger); }
        .color-reserved { background-color: var(--warning); }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--spacing-md); padding-bottom: 60px; /* Space for bottom nav/cart */ }
        .table-item {
            aspect-ratio: 1; background-color: var(--card-bg); border-radius: var(--radius-md);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; padding: var(--spacing-sm); text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-fast), box-shadow var(--transition-std), border-color var(--transition-std);
            position: relative; overflow: hidden; border: 2px solid transparent; /* Base border */
        }
        .table-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .table-item:active { transform: scale(0.97); box-shadow: var(--shadow-sm); }
        .table-free { border-color: var(--success); }
        .table-occupied { border-color: var(--danger); }
        .table-reserved { border-color: var(--warning); }
        .table-urgent { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6), var(--shadow-sm); } /* Combine shadows */
            70% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0), var(--shadow-sm); }
        }
        .table-number { font-size: 1.375rem; font-weight: 800; margin-bottom: 0.1rem; color: var(--text-color); }
        .table-capacity { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .table-time { font-size: 0.8rem; font-weight: 600; }
        .table-occupied .table-time { color: var(--danger); }
        .table-reserved .table-time { color: var(--warning); }

        /* Order View */
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-color); gap: var(--spacing-md); }
        .table-info { display: flex; align-items: center; gap: var(--spacing-md); }
        .table-icon {
            width: 48px; height: 48px; background-color: var(--primary-light); color: var(--primary);
            border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.5rem;
        }
        .table-number-info { font-size: 1.375rem; font-weight: 700; color: var(--text-color); }
        .table-meta { display: flex; flex-wrap: wrap; color: var(--text-muted); font-size: 0.875rem; gap: 0 0.5rem; }
        .table-meta span:not(:last-child):after { content: "•"; margin-left: 0.5rem; opacity: 0.7; }
        .history-link { cursor: pointer; color: var(--primary); }
        .history-link:hover { text-decoration: underline; }
        .back-btn {
            min-width: var(--touch-target); height: var(--touch-target); border-radius: var(--radius-md);
            border: 1px solid var(--border-color); background-color: var(--card-bg); /* Changed background */
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); cursor: pointer; padding: 0 1rem; gap: 0.5rem;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .back-btn:hover { background-color: var(--gray-100); color: var(--text-color); }

        /* Search */
        .search-container { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        .search-box { position: relative; flex: 1; }
        .search-input {
            width: 100%; height: var(--touch-target); padding: 0 1rem 0 2.75rem;
            border: 1px solid var(--border-color); border-radius: var(--radius-md);
            background-color: var(--card-bg); color: var(--text-color); font-size: 1rem;
            transition: border-color var(--transition-std), box-shadow var(--transition-std);
        }
        .search-input::placeholder { color: var(--text-muted); }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.875rem; }
        .voice-btn {
            width: var(--touch-target); height: var(--touch-target); flex-shrink: 0;
            background-color: var(--primary); color: var(--white); border: none; border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
        }
        .voice-btn:hover { background-color: var(--primary-dark); }
        .voice-btn:active { transform: scale(0.95); }

        /* Categories */
        .categories { display: flex; overflow-x: auto; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); scrollbar-width: none; -ms-overflow-style: none; padding-bottom: 4px; }
        .categories::-webkit-scrollbar { display: none; }
        .category {
            flex: 0 0 auto; padding: 0.5rem 1rem; background-color: var(--gray-100); color: var(--text-muted);
            border-radius: var(--radius-full); font-weight: 600; font-size: 0.875rem;
            white-space: nowrap; cursor: pointer; border: 1px solid transparent; /* Base border */
            transition: background-color var(--transition-std), color var(--transition-std), border-color var(--transition-std);
        }
        .category:hover { background-color: var(--gray-200); color: var(--text-color); }
        .category.active { background-color: var(--primary-light); color: var(--primary); border-color: var(--primary); }

        /* Menu Grid */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: var(--spacing-md); padding-bottom: 80px; /* Space for cart */ }
        .menu-item {
            background-color: var(--card-bg); border-radius: var(--radius-md); overflow: hidden;
            box-shadow: var(--shadow-sm); cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-std);
            position: relative; display: flex; flex-direction: column;
        }
        .menu-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .menu-item:active { transform: scale(0.97); }
        .menu-img-container { position: relative; overflow: hidden; } /* Container for image effects */
        .menu-img {
            display: block; width: 100%; aspect-ratio: 4/3; object-fit: cover;
            transition: filter var(--transition-std), transform var(--transition-std);
        }
        .menu-item:hover .menu-img { filter: brightness(0.85); transform: scale(1.03); }
        .menu-badge {
            position: absolute; top: var(--spacing-sm); right: var(--spacing-sm);
            width: 28px; height: 28px; border-radius: 50%; background-color: rgba(255,255,255,0.9);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); backdrop-filter: blur(2px);
            font-size: 0.8rem;
        }
        .badge-allergic { color: var(--danger); animation: blink 1.8s infinite ease-in-out; }
        .badge-vegan { color: var(--success); }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.9); } }
        .menu-content { padding: var(--spacing-sm) var(--spacing-md); flex-grow: 1; }
        .menu-title {
            font-weight: 600; margin-bottom: 0.25rem; line-height: 1.3; color: var(--text-color);
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
            -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 2.6em; /* 2 * line-height */
        }
        .menu-price { color: var(--primary); font-weight: 700; font-size: 1rem; margin-top: auto; } /* Aligns price to bottom if content height varies */

        /* Cart */
        .cart {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            z-index: var(--z-cart);
            transform: translateY(calc(100% - 60px)); /* Initial collapsed state (summary visible) */
            transition: transform var(--transition-slow), background-color var(--transition-std), border-color var(--transition-std);
            border-top: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            max-height: 80vh; /* Limit height when expanded */
        }
        .cart.expanded { transform: translateY(0); }
        .cart-header { /* Combine handle and summary */
            padding: 0.5rem var(--spacing-md) 0;
            cursor: pointer; /* Make header clickable to expand/collapse */
        }
        .cart-handle {
            width: 40px; height: 5px; background-color: var(--gray-300);
            border-radius: 2.5px; margin: 0 auto var(--spacing-sm);
        }
        .cart-summary {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 0.75rem;
        }
        .cart-title { font-weight: 600; font-size: 1rem; color: var(--text-color); }
        .cart-count { color: var(--text-muted); font-size: 0.875rem; margin-left: 0.25rem; }
        .cart-total { font-weight: 700; color: var(--primary); font-size: 1rem; }
        .cart-toggle-btn { /* Removed old cart-btn, integrated into header */
            background: none; border: none; color: var(--primary); font-weight: 600;
            cursor: pointer; font-size: 0.875rem; padding: 0.5rem; margin-right: -0.5rem; /* Align right */
        }
        .cart-toggle-btn i { margin-left: 0.25rem; transition: transform var(--transition-std); }
        .cart.expanded .cart-toggle-btn i { transform: rotate(180deg); } /* Arrow indication */

        .cart-content {
            overflow-y: auto; flex-grow: 1; /* Takes remaining space */
            padding: 0 var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }
        .cart-item { display: flex; padding: var(--spacing-md) 0; border-bottom: 1px solid var(--border-color); gap: var(--spacing-sm); }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-details { flex: 1; }
        .cart-item-title { font-weight: 600; margin-bottom: 0.1rem; color: var(--text-color); }
        .cart-item-options { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .cart-item-price { font-weight: 500; font-size: 0.875rem; color: var(--text-color); }
        .cart-item-actions { display: flex; align-items: center; gap: var(--spacing-xs); }
        .qty-btn {
            width: 32px; height: 32px; background-color: var(--gray-100); border: none;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-muted); font-size: 1rem;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .qty-btn:hover { background-color: var(--gray-200); color: var(--text-color); }
        .qty-value { min-width: 30px; text-align: center; font-weight: 600; font-size: 1rem; color: var(--text-color); }

        .cart-footer {
            padding: var(--spacing-md); border-top: 1px solid var(--border-color);
            background-color: var(--card-bg); /* Ensure background for sticky feel */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .subtotal-row { display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem; }
        .subtotal-label { color: var(--text-muted); }
        .subtotal-value { font-weight: 500; color: var(--text-color); }
        .total-row { display: flex; justify-content: space-between; font-weight: 700; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); }
        .total-label { font-size: 1rem; color: var(--text-color); }
        .total-value { font-size: 1.25rem; color: var(--primary); }
        .cart-actions { display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-sm); margin-top: var(--spacing-md); }

        /* Buttons */
        .btn {
            padding: 0.75rem 1rem; height: var(--touch-target);
            border-radius: var(--radius-md); font-weight: 600; font-size: 0.875rem;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer; border: 1px solid transparent; /* Base border */
            transition: background-color var(--transition-std), color var(--transition-std), border-color var(--transition-std), transform var(--transition-fast), box-shadow var(--transition-std);
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn-outline:hover { background-color: var(--gray-100); }
        .btn-primary { background-color: var(--primary); border-color: var(--primary); color: var(--white); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary); border-color: var(--secondary); color: var(--white); }
        .btn-secondary:hover { background-color: var(--secondary-dark); border-color: var(--secondary-dark); }
        .btn-danger { background-color: var(--danger); border-color: var(--danger); color: var(--white); }
        .btn-danger:hover { background-color: #D92D20; border-color: #D92D20; } /* Darker red */
        .btn i { font-size: 1em; /* Relative to button font size */ }

        /* Item Customization Modal */
        .modal-overlay {
            position: fixed; inset: 0; /* top, left, right, bottom = 0 */
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
            z-index: var(--z-overlay);
            opacity: 0; visibility: hidden;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 90%; max-width: 500px; max-height: 90vh;
            background-color: var(--card-bg); border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            z-index: var(--z-modal);
            opacity: 0; visibility: hidden;
            transition: transform var(--transition-slow), opacity var(--transition-slow), visibility var(--transition-slow), background-color var(--transition-std);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .modal.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--text-color); }
        .modal-close {
            width: 36px; height: 36px; background: none; border: none; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); cursor: pointer; font-size: 1.25rem;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .modal-close:hover { background-color: var(--gray-100); color: var(--text-color); }
        .modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: var(--spacing-lg); } /* Scrollable body */
        .option-section { margin-bottom: var(--spacing-lg); }
        .option-title { font-weight: 600; margin-bottom: 0.75rem; color: var(--text-color); font-size: 1rem; }
        .option-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: var(--spacing-sm); }
        .option-item {
            padding: 0.75rem; background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--radius-md); text-align: center; cursor: pointer; font-size: 0.875rem; color: var(--text-color);
            transition: background-color var(--transition-std), border-color var(--transition-std), color var(--transition-std);
        }
        .option-item:hover { background-color: var(--gray-100); }
        .option-item.active { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .extras-list { display: flex; flex-direction: column; gap: var(--spacing-sm); }
        .extra-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background-color: var(--gray-50); border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer; }
        .extra-label { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; color: var(--text-color); }
        .checkbox {
            width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 4px;
            position: relative; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            transition: background-color var(--transition-std), border-color var(--transition-std);
        }
        .checkbox.checked { background-color: var(--primary); border-color: var(--primary); }
        .checkbox.checked::after {
            content: '\f00c'; /* FontAwesome check icon */
            font-family: 'Font Awesome 6 Free'; font-weight: 900;
            color: var(--white); font-size: 0.75rem;
        }
        .extra-price { font-weight: 600; font-size: 0.875rem; color: var(--text-muted); }
        .notes-field {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);
            resize: vertical; min-height: 80px; background-color: var(--card-bg); color: var(--text-color); font-size: 0.875rem;
            transition: border-color var(--transition-std), box-shadow var(--transition-std);
        }
        .notes-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
        .modal-actions { display: flex; gap: var(--spacing-sm); margin-top: auto; flex-shrink: 0; padding-top: var(--spacing-md); border-top: 1px solid var(--border-color); }
        .modal-actions .btn { flex: 1; }

        /* Payment section */
        .payment-methods { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
        .payment-method {
            background-color: var(--card-bg); border: 2px solid var(--border-color); /* Use border for active state */
            border-radius: var(--radius-md); padding: var(--spacing-md);
            display: flex; flex-direction: column; align-items: center; text-align: center;
            cursor: pointer; position: relative; /* For checkmark */
            transition: border-color var(--transition-std), background-color var(--transition-std);
        }
        .payment-method:hover { background-color: var(--gray-100); }
        .payment-method.active { border-color: var(--primary); background-color: var(--primary-light); }
        /* Checkmark for active method */
        .payment-method.active::after {
            content: '\f058'; /* FontAwesome solid check circle */
            font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; top: 8px; right: 8px;
            color: var(--primary); font-size: 1rem;
            background-color: var(--primary-light); /* Match background */
            border-radius: 50%;
        }
        .payment-icon { font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem; transition: color var(--transition-std); }
        .payment-method.active .payment-icon { color: var(--primary); }
        .payment-name { font-weight: 600; font-size: 0.875rem; color: var(--text-color); }

        .payment-summary { background-color: var(--card-bg); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); box-shadow: var(--shadow-sm); }
        .summary-title { font-weight: 700; margin-bottom: var(--spacing-md); font-size: 1.125rem; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem; }

        .amount-field { position: relative; margin-bottom: var(--spacing-md); }
        .amount-field span { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-weight: 600; color: var(--text-muted); }
        .amount-input {
            width: 100%; height: 50px; padding: 0.75rem 1rem 0.75rem 2.5rem;
            font-size: 1.75rem; font-weight: 700; text-align: right;
            border: 1px solid var(--border-color); border-radius: var(--radius-md);
            background-color: var(--card-bg); color: var(--text-color);
            transition: border-color var(--transition-std), box-shadow var(--transition-std);
        }
        .amount-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        .numkey {
            aspect-ratio: 1.5 / 1; /* Wider keys */
            font-size: 1.5rem; font-weight: 600; /* Slightly less bold */
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--radius-md); cursor: pointer; color: var(--text-color);
            display: flex; align-items: center; justify-content: center;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
        }
        .numkey:hover { background-color: var(--gray-100); }
        .numkey:active { background-color: var(--gray-200); transform: scale(0.96); }
        .numkey[data-key="C"] { color: var(--danger); font-weight: 700; } /* Style clear button */

        .change-panel { background-color: var(--secondary-light); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); border: 1px solid var(--secondary-dark); }
        .change-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); }
        .change-label { font-weight: 600; color: var(--secondary-dark); }
        .change-amount { font-weight: 700; font-size: 1.25rem; color: var(--secondary-dark); }
        .bills-display { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: var(--spacing-sm); }
        .bill { padding: 0.5rem 0.75rem; background-color: #E0F2FE; border: 1px solid #7DD3FC; border-radius: var(--radius-sm); font-weight: 600; text-align: center; min-width: 60px; font-size: 0.875rem; color: #075985; }
        .coin { width: 36px; height: 36px; border-radius: 50%; background-color: #FEF3C7; border: 1px solid #FDE68A; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; color: #92400E; }
        .tip-option { display: flex; align-items: center; margin-top: var(--spacing-md); cursor: pointer; }
        .tip-checkbox { margin-right: 0.75rem; accent-color: var(--secondary-dark); width: 18px; height: 18px; } /* Native checkbox styling */
        .tip-label { color: var(--secondary-dark); font-weight: 500; font-size: 0.875rem; }

        /* Receipt view */
        .receipt { max-width: 360px; /* Slightly wider */ margin: 0 auto var(--spacing-lg); background-color: var(--card-bg); border-radius: var(--radius-md); box-shadow: var(--shadow-md); overflow: hidden; }
        .receipt-header { padding: var(--spacing-md); text-align: center; border-bottom: 1px dashed var(--border-color); }
        .receipt-logo { font-weight: 800; font-size: 1.25rem; margin-bottom: 0.25rem; color: var(--text-color); }
        .receipt-restaurant { font-weight: 700; margin-bottom: 0.25rem; color: var(--text-color); }
        .receipt-address, .receipt-info { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; line-height: 1.3; }
        .receipt-body { padding: var(--spacing-md); }
        .receipt-items { margin-bottom: var(--spacing-md); font-size: 0.875rem; }
        .receipt-item { display: grid; grid-template-columns: 30px 1fr auto; gap: var(--spacing-sm); margin-bottom: 0.5rem; align-items: start; }
        .item-qty { color: var(--text-muted); text-align: right; }
        .item-name { color: var(--text-color); }
        .item-price { font-weight: 500; text-align: right; color: var(--text-color); }
        .receipt-subtotals { padding-top: var(--spacing-md); border-top: 1px dashed var(--border-color); font-size: 0.875rem; }
        /* Use grid for subtotals too */
        .receipt-subtotals .receipt-item { grid-template-columns: 1fr auto; }
        .receipt-subtotals .item-name { font-weight: 600; }
        .receipt-subtotals .receipt-item:last-of-type .item-name,
        .receipt-subtotals .receipt-item:last-of-type .item-price { font-weight: 700; font-size: 1rem; }

        .receipt-footer { padding: var(--spacing-md); text-align: center; border-top: 1px dashed var(--border-color); }
        .receipt-message { margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--text-muted); }
        .receipt-qr {
            width: 100px; height: 100px; background-color: var(--gray-100);
            margin: 0 auto var(--spacing-md); display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; color: var(--text-muted); border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
        }
        .receipt-actions { display: flex; justify-content: center; gap: var(--spacing-sm); flex-wrap: wrap; margin-top: var(--spacing-md); }
        .action-btn { flex: 1; min-width: 100px; max-width: 150px; } /* Adjusted buttons */

        .payment-success-panel {
             background-color: var(--success-light, var(--secondary-light)); /* Fallback */
             border: 1px solid var(--success, var(--secondary));
             border-radius: var(--radius-md); padding: var(--spacing-md);
             margin-top: var(--spacing-lg);
        }
        .payment-success-title {
             color: var(--success-dark, var(--secondary-dark)); /* Fallback */
             font-weight: 700; font-size: 1.125rem;
             display: flex; align-items: center; gap: 0.5rem;
             margin-bottom: var(--spacing-sm);
        }
         .payment-success-message {
             font-size: 0.875rem; color: var(--text-muted);
             margin-bottom: var(--spacing-md);
         }


        /* Bottom Navigation */
        .bottom-nav {
            display: flex; background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: var(--z-header); /* Below cart handle */
            transition: background-color var(--transition-std), border-color var(--transition-std);
        }
        .bottom-nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 0.5rem 0.25rem; /* Reduced padding */
            color: var(--text-muted); text-decoration: none; font-size: 0.7rem; /* Smaller text */
            font-weight: 500;
            position: relative; /* For badge */
            transition: color var(--transition-std); border-top: 3px solid transparent; /* Indicator */
            min-height: 56px; /* Consistent height */
            justify-content: center;
        }
        .bottom-nav-item:hover { color: var(--text-color); }
        .bottom-nav-item[aria-selected="true"] { color: var(--primary); border-top-color: var(--primary); }
        .bottom-nav-icon { font-size: 1.2rem; margin-bottom: 0.1rem; } /* Adjusted size */
        .bottom-nav-label { display: block; } /* Ensure label is block */
        .bottom-nav-badge {
            position: absolute; top: 4px; right: calc(50% - 20px); /* Adjust position */
            background-color: var(--danger); color: white; font-size: 0.625rem; font-weight: 600;
            min-width: 16px; height: 16px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; padding: 0 4px;
            border: 1px solid var(--card-bg); /* Helps visibility */
        }

        /* Stats Tab */
        #stats-tab .payment-summary { margin-bottom: var(--spacing-md); } /* Re-use payment summary style */
        .progress-bar-container {
             height: 8px; width: 100%; background-color: var(--gray-100);
             border-radius: 4px; margin-top: 0.25rem; overflow: hidden;
        }
        .progress-bar {
            height: 100%; background-color: var(--primary); border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }

        /* Toast notification */
        .toast-container {
            position: fixed;
            left: 50%;
            bottom: 70px; /* Above bottom nav */
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .toast {
            background-color: rgba(17, 24, 39, 0.9); /* Dark background */
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity var(--transition-slow), transform var(--transition-slow);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-success { background-color: rgba(5, 150, 105, 0.9); } /* Success color */
        .toast.toast-error { background-color: rgba(220, 38, 38, 0.9); } /* Error color */
        .toast i { font-size: 1rem; }


        /* Responsive adjustments */
        @media (min-width: 768px) {
            .tables-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .menu-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .bottom-nav { display: none; } /* Hide bottom nav on larger screens */
            .tab-content { padding-bottom: var(--spacing-xl); } /* More padding when no bottom nav */
            .cart { /* Optional: Make cart a sidebar on large screens */
                /* width: 350px; left: auto; right: 0; top: 0; height: 100%; border-radius: 0; transform: translateX(100%); */
                /* Needs JS adjustment to handle sidebar toggle */
            }
             .toast-container { bottom: 20px; } /* Adjust toast position */
        }
        @media (max-width: 767px) {
            .tab-content { padding-bottom: 70px; } /* Ensure space for bottom nav */
            .tab { padding: 0.75rem 1rem; font-size: 0.8rem; } /* Slightly smaller tabs */
            .header-right { gap: var(--spacing-xs); }
            .datetime { display: none; } /* Hide datetime on small screens */
            .user-info { padding-left: var(--spacing-xs); margin-left: var(--spacing-xs); }
            .tables-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: var(--spacing-sm); } /* Smaller tables */
            .menu-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--spacing-sm); } /* Smaller menu items */
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s forwards ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Utility class for hidden */
        [hidden] { display: none !important; }

        /* Accessibility: Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .table-urgent { animation: none; } /* Disable pulsing */
        }

         /* Visually Hidden Class for Accessibility */
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <!-- === Original Logo HTML Structure START === -->
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-utensils" aria-hidden="true"></i> <!-- Icône arrière -->
                    <i class="fas fa-utensils" aria-hidden="true"></i> <!-- Icône avant -->
                </div>
                <div class="logo-text">OctoPOS</div>
            </div>
            <!-- === Original Logo HTML Structure END === -->

            <div class="header-right">
                <div class="datetime">2025-04-10 14:03:53</div>

                <div class="header-buttons">
                    <button id="theme-toggle" class="header-button" aria-label="Basculer le thème sombre/clair">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="contrast-toggle" class="header-button" aria-label="Basculer le mode contraste élevé">
                        <i class="fas fa-adjust"></i> <!-- Changed icon for contrast -->
                    </button>
                    <button id="notifications" class="header-button" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge" aria-hidden="true">3</span>
                    </button>
                </div>

                <div class="user-info">
                    <div class="avatar" aria-hidden="true">HB</div>
                    <div class="user-details">
                        <div class="user-name">Hamza Br</div>
                        <div class="user-role">Serveur</div>
                    </div>
                     <button class="header-button" aria-label="Menu utilisateur">
                        <i class="fas fa-ellipsis-v"></i> <!-- Example: User options button -->
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs" role="tablist" aria-label="Navigation principale">
            <button class="tab" role="tab" aria-selected="true" aria-controls="tables-tab" data-tab="tables" id="tab-tables">
                <i class="fas fa-th-large" aria-hidden="true"></i> Tables
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="orders-tab" data-tab="orders" id="tab-orders" tabindex="-1">
                <i class="fas fa-utensils" aria-hidden="true"></i> Commande
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="payment-tab" data-tab="payment" id="tab-payment" tabindex="-1">
                <i class="fas fa-cash-register" aria-hidden="true"></i> Paiement
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="receipt-tab" data-tab="receipt" id="tab-receipt" tabindex="-1">
                <i class="fas fa-receipt" aria-hidden="true"></i> Tickets
            </button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="stats-tab" data-tab="stats" id="tab-stats" tabindex="-1">
                <i class="fas fa-chart-line" aria-hidden="true"></i> Stats
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tables Tab Content -->
            <div id="tables-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-tables">
                <div class="table-controls">
                    <div class="view-toggle" role="group" aria-label="Changer la vue des tables">
                        <button class="view-btn active" aria-pressed="true" aria-label="Vue grille">
                            <i class="fas fa-th-large" aria-hidden="true"></i>
                        </button>
                        <button class="view-btn" aria-pressed="false" aria-label="Vue liste">
                            <i class="fas fa-list" aria-hidden="true"></i>
                        </button>
                    </div>

                    <div class="status-legend" aria-label="Légende des statuts de table">
                        <div class="status-item"><div class="status-color color-free"></div><span>Libre</span></div>
                        <div class="status-item"><div class="status-color color-occupied"></div><span>Occupée</span></div>
                        <div class="status-item"><div class="status-color color-reserved"></div><span>Réservée</span></div>
                    </div>
                </div>

                <div class="tables-grid">
                    <!-- Table 1 -->
                    <div class="table-item table-free" data-table="1" tabindex="0" role="button" aria-label="Table 1, 4 personnes, Libre">
                        <div class="table-number">T1</div>
                        <div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 4</div>
                    </div>
                    <!-- Table 2 -->
                    <div class="table-item table-occupied" data-table="2" tabindex="0" role="button" aria-label="Table 2, 2 personnes, Occupée depuis 35 minutes">
                        <div class="table-number">T2</div>
                        <div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 2</div>
                        <div class="table-time"><i class="fas fa-clock" aria-hidden="true"></i> 35 min</div>
                    </div>
                     <!-- Table 3 -->
                    <div class="table-item table-occupied table-urgent" data-table="3" tabindex="0" role="button" aria-label="Table 3, 6 personnes, Occupée depuis 52 minutes, Urgent">
                        <div class="table-number">T3</div>
                        <div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 6</div>
                        <div class="table-time"><i class="fas fa-clock" aria-hidden="true"></i> 52 min</div>
                    </div>
                     <!-- Table 4 -->
                    <div class="table-item table-reserved" data-table="4" tabindex="0" role="button" aria-label="Table 4, 4 personnes, Réservée pour 19:30">
                        <div class="table-number">T4</div>
                        <div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 4</div>
                        <div class="table-time"><i class="fas fa-calendar-alt" aria-hidden="true"></i> 19:30</div>
                    </div>
                    <!-- Add more tables following the pattern -->
                     <div class="table-item table-free" data-table="5" tabindex="0" role="button" aria-label="Table 5, 2 personnes, Libre"> <div class="table-number">T5</div><div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 2</div></div>
                     <div class="table-item table-free" data-table="6" tabindex="0" role="button" aria-label="Table 6, 4 personnes, Libre"> <div class="table-number">T6</div><div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 4</div></div>
                     <div class="table-item table-reserved" data-table="7" tabindex="0" role="button" aria-label="Table 7, 2 personnes, Réservée pour 20:15"> <div class="table-number">T7</div><div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 2</div><div class="table-time"><i class="fas fa-calendar-alt" aria-hidden="true"></i> 20:15</div></div>
                     <div class="table-item table-free" data-table="8" tabindex="0" role="button" aria-label="Table 8, 6 personnes, Libre"> <div class="table-number">T8</div><div class="table-capacity"><i class="fas fa-users" aria-hidden="true"></i> 6</div></div>
                </div>
            </div>

            <!-- Orders Tab Content -->
            <div id="orders-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-orders" hidden>
                 <div class="order-header">
                    <div class="table-info">
                        <div class="table-icon" aria-hidden="true"><i class="fas fa-chair"></i></div>
                        <div>
                            <div class="table-number-info">Sélectionner une table</div>
                            <div class="table-meta">
                                <!-- Filled by JS -->
                            </div>
                        </div>
                    </div>
                    <button id="back-to-tables" class="back-btn">
                        <i class="fas fa-arrow-left" aria-hidden="true"></i>
                        <span>Retour</span>
                    </button>
                </div>

                 <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon" aria-hidden="true"></i>
                        <input type="search" class="search-input" placeholder="Rechercher un plat..." aria-label="Rechercher un plat">
                    </div>
                    <button class="voice-btn" aria-label="Recherche vocale">
                        <i class="fas fa-microphone" aria-hidden="true"></i>
                    </button>
                </div>

                <!-- Categories -->
                <div class="categories" role="tablist" aria-label="Filtrer par catégorie">
                    <button class="category active" role="tab" aria-selected="true">Tous</button>
                    <button class="category" role="tab" aria-selected="false">Entrées</button>
                    <button class="category" role="tab" aria-selected="false">Plats</button>
                    <button class="category" role="tab" aria-selected="false">Desserts</button>
                    <button class="category" role="tab" aria-selected="false">Boissons</button>
                    <button class="category" role="tab" aria-selected="false">Vins</button>
                    <button class="category" role="tab" aria-selected="false">Menu du jour</button>
                </div>

                <!-- Menu Grid -->
                <div class="menu-grid">
                    <!-- Menu item 1 -->
                    <div class="menu-item" data-id="1" data-name="Salade César" data-price="14.50" tabindex="0" role="button" aria-label="Ajouter Salade César, 14,50€">
                        <div class="menu-img-container">
                             <img src="https://source.unsplash.com/800x600/?cesar-salad" alt="Salade César fraîche avec poulet grillé et croûtons" class="menu-img">
                             <div class="menu-badge badge-vegan" title="Vegan">
                                <i class="fas fa-leaf" aria-hidden="true"></i>
                             </div>
                        </div>
                        <div class="menu-content">
                            <div class="menu-title">Salade César</div>
                            <div class="menu-price">14,50€</div>
                        </div>
                    </div>
                    <!-- Menu item 2 -->
                    <div class="menu-item" data-id="2" data-name="Soupe à l'oignon" data-price="10.50" tabindex="0" role="button" aria-label="Ajouter Soupe à l'oignon, 10,50€">
                         <div class="menu-img-container">
                            <img src="https://source.unsplash.com/800x600/?onion-soup" alt="Soupe à l'oignon gratinée avec du fromage fondant" class="menu-img">
                         </div>
                        <div class="menu-content">
                            <div class="menu-title">Soupe à l'oignon</div>
                            <div class="menu-price">10,50€</div>
                        </div>
                    </div>
                     <!-- Menu item 3 -->
                    <div class="menu-item" data-id="3" data-name="Filet de Boeuf" data-price="26.90" tabindex="0" role="button" aria-label="Ajouter Filet de Boeuf, 26,90€">
                         <div class="menu-img-container">
                            <img src="https://source.unsplash.com/800x600/?beef-steak" alt="Filet de bœuf grillé servi avec des frites" class="menu-img">
                         </div>
                        <div class="menu-content">
                            <div class="menu-title">Filet de Boeuf</div>
                            <div class="menu-price">26,90€</div>
                        </div>
                    </div>
                     <!-- Menu item 4 -->
                    <div class="menu-item" data-id="4" data-name="Risotto aux Cèpes" data-price="19.90" tabindex="0" role="button" aria-label="Ajouter Risotto aux Cèpes, 19,90€">
                         <div class="menu-img-container">
                            <img src="https://source.unsplash.com/800x600/?risotto" alt="Risotto crémeux aux cèpes frais et parmesan" class="menu-img">
                         </div>
                        <div class="menu-content">
                            <div class="menu-title">Risotto aux Cèpes</div>
                            <div class="menu-price">19,90€</div>
                        </div>
                    </div>
                     <!-- Menu item 5 -->
                     <div class="menu-item" data-id="5" data-name="Saumon Grillé" data-price="22.50" tabindex="0" role="button" aria-label="Ajouter Saumon Grillé, 22,50€, contient des allergènes">
                         <div class="menu-img-container">
                             <img src="https://source.unsplash.com/800x600/?grilled-salmon" alt="Pavé de saumon grillé avec légumes vapeur" class="menu-img">
                             <div class="menu-badge badge-allergic" title="Contient des allergènes (poisson)">
                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i> <!-- Changed icon -->
                             </div>
                         </div>
                         <div class="menu-content">
                             <div class="menu-title">Saumon Grillé</div>
                             <div class="menu-price">22,50€</div>
                         </div>
                     </div>
                     <!-- Menu item 6 -->
                    <div class="menu-item" data-id="6" data-name="Crème Brûlée" data-price="8.90" tabindex="0" role="button" aria-label="Ajouter Crème Brûlée, 8,90€">
                         <div class="menu-img-container">
                            <img src="https://source.unsplash.com/800x600/?creme-brulee" alt="Crème brûlée classique avec une croûte caramélisée" class="menu-img">
                         </div>
                        <div class="menu-content">
                            <div class="menu-title">Crème Brûlée</div>
                            <div class="menu-price">8,90€</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Tab Content -->
            <div id="payment-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-payment" hidden>
                 <h2 class="summary-title">Mode de paiement</h2>
                <div class="payment-methods" role="radiogroup" aria-labelledby="payment-method-label">
                    <div id="payment-method-label" class="visually-hidden">Choisir un mode de paiement</div> <!-- Hidden label for ARIA -->
                    <div class="payment-method active" data-method="cash" role="radio" aria-checked="true" tabindex="0">
                        <div class="payment-icon"><i class="fas fa-money-bill-wave" aria-hidden="true"></i></div>
                        <div class="payment-name">Espèces</div>
                    </div>
                    <div class="payment-method" data-method="card" role="radio" aria-checked="false" tabindex="-1">
                        <div class="payment-icon"><i class="fas fa-credit-card" aria-hidden="true"></i></div>
                        <div class="payment-name">Carte Bancaire</div>
                    </div>
                    <div class="payment-method" data-method="split" role="radio" aria-checked="false" tabindex="-1">
                        <div class="payment-icon"><i class="fas fa-users" aria-hidden="true"></i></div>
                        <div class="payment-name">Addition Partagée</div>
                    </div>
                     <div class="payment-method" data-method="mobile" role="radio" aria-checked="false" tabindex="-1">
                        <div class="payment-icon"><i class="fas fa-mobile-alt" aria-hidden="true"></i></div>
                        <div class="payment-name">Paiement Mobile</div>
                    </div>
                </div>

                 <div class="payment-summary">
                    <div class="summary-title">Récapitulatif <span class="table-number-payment" style="font-weight: normal; color: var(--text-muted);">(Table 3)</span></div>
                    <div class="subtotal-row"><div class="subtotal-label">Articles</div><div class="subtotal-value cart-item-count">5</div></div>
                    <div class="subtotal-row"><div class="subtotal-label">Sous-total</div><div class="subtotal-value cart-subtotal">66,30€</div></div>
                    <div class="subtotal-row"><div class="subtotal-label">TVA (10%)</div><div class="subtotal-value cart-tax">6,63€</div></div>
                    <div class="total-row"><div class="total-label">Total à payer</div><div class="total-value cart-grand-total">72,93€</div></div>
                </div>

                 <!-- Cash Payment Section (Example - adjust visibility based on selected method) -->
                <div class="cash-payment-details">
                    <div class="amount-field">
                        <span>€</span>
                        <input type="text" class="amount-input" value="0,00" inputmode="decimal" aria-label="Montant reçu en espèces">
                    </div>
                    <div class="numpad" aria-label="Clavier numérique pour le montant reçu">
                        <button class="numkey" data-key="7">7</button> <button class="numkey" data-key="8">8</button> <button class="numkey" data-key="9">9</button>
                        <button class="numkey" data-key="4">4</button> <button class="numkey" data-key="5">5</button> <button class="numkey" data-key="6">6</button>
                        <button class="numkey" data-key="1">1</button> <button class="numkey" data-key="2">2</button> <button class="numkey" data-key="3">3</button>
                        <button class="numkey" data-key="0">0</button> <button class="numkey" data-key="00">00</button> <button class="numkey" data-key="C" aria-label="Effacer">C</button>
                    </div>
                    <div class="change-panel">
                        <div class="change-title"><div class="change-label">Monnaie à rendre</div><div class="change-amount">0,00€</div></div>
                        <div class="bills-display" aria-label="Détail de la monnaie à rendre">
                            <!-- Filled by JS -->
                        </div>
                        <label class="tip-option" for="round-tip">
                            <input type="checkbox" class="tip-checkbox" id="round-tip">
                            <span class="tip-label">Arrondir pour pourboire (<span class="tip-amount">0,00€</span>)</span>
                        </label>
                    </div>
                </div> <!-- End cash-payment-details -->

                 <div class="modal-actions">
                    <button class="btn btn-outline" id="cancel-payment"><i class="fas fa-times" aria-hidden="true"></i> Annuler</button>
                    <button class="btn btn-primary" id="complete-payment"><i class="fas fa-check" aria-hidden="true"></i> Valider Paiement</button>
                </div>
            </div>

            <!-- Receipt Tab Content -->
            <div id="receipt-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-receipt" hidden>
                <div class="receipt-container" style="max-width: 600px; margin: auto;"> <!-- Container for centering -->
                    <div class="receipt">
                         <div class="receipt-header">
                            <div class="receipt-logo">OctoPOS</div>
                            <div class="receipt-restaurant">Le Bistro Gourmand</div>
                            <div class="receipt-address">123 Rue de la Saveur, 75001 Paris</div>
                            <div class="receipt-info">Tel: 01 98 76 54 32</div>
                            <div class="receipt-info">Table: <span class="receipt-table-num">3</span> - Serveur: Hamza B.</div>
                            <div class="receipt-info receipt-datetime">2025-04-10 14:03:53</div>
                        </div>

                        <div class="receipt-body">
                            <div class="receipt-items" aria-label="Articles commandés">
                                <!-- Items will be dynamically added here by JS, example: -->
                                <div class="receipt-item">
                                    <div class="item-qty">1x</div>
                                    <div class="item-name">Filet de Boeuf</div>
                                    <div class="item-price">26,90€</div>
                                </div>
                                <div class="receipt-item">
                                    <div class="item-qty">1x</div>
                                    <div class="item-name">Risotto aux Cèpes</div>
                                    <div class="item-price">19,90€</div>
                                </div>
                                <div class="receipt-item">
                                    <div class="item-qty">2x</div>
                                    <div class="item-name">Verre de Vin Rouge</div>
                                    <div class="item-price">15,00€</div>
                                </div>
                                <div class="receipt-item">
                                    <div class="item-qty">1x</div>
                                    <div class="item-name">Eau Minérale (50cl)</div>
                                    <div class="item-price">4,50€</div>
                                </div>
                            </div>

                            <div class="receipt-subtotals" aria-label="Totaux">
                                <div class="receipt-item">
                                    <div class="item-name">Sous-total HT:</div>
                                    <div class="item-price receipt-subtotal-val">66,30€</div>
                                </div>
                                <div class="receipt-item">
                                    <div class="item-name">TVA (10%):</div>
                                    <div class="item-price receipt-tax-val">6,63€</div>
                                </div>
                                <div class="receipt-item" style="font-weight: bold; border-top: 1px solid var(--border-color); padding-top: var(--spacing-sm); margin-top: var(--spacing-sm);">
                                    <div class="item-name">TOTAL TTC:</div>
                                    <div class="item-price receipt-total-val">72,93€</div>
                                </div>
                                <div class="receipt-item receipt-payment-details"> <!-- Filled by JS -->
                                    <div class="item-name">Payé (Espèces):</div>
                                    <div class="item-price receipt-paid-val">80,00€</div>
                                </div>
                                <div class="receipt-item receipt-payment-details"> <!-- Filled by JS -->
                                    <div class="item-name">Rendu:</div>
                                    <div class="item-price receipt-change-val">7,07€</div>
                                </div>
                            </div>
                        </div>

                        <div class="receipt-footer">
                            <div class="receipt-message">Merci de votre visite et à bientôt !</div>
                            <div class="receipt-message">TVA N° FR123456789</div>
                            <div class="receipt-qr" aria-label="QR Code pour laisser un avis">
                                <!-- Placeholder for QR code image or SVG -->
                                <i class="fas fa-qrcode" style="font-size: 4rem; color: var(--text-muted);"></i>
                            </div>
                            <div class="receipt-message">Scannez pour laisser votre avis</div>
                        </div>
                    </div>

                    <div class="receipt-actions">
                        <button class="btn btn-primary action-btn" aria-label="Imprimer le ticket">
                            <i class="fas fa-print" aria-hidden="true"></i> Imprimer
                        </button>
                        <button class="btn btn-outline action-btn" aria-label="Envoyer le ticket par Email">
                            <i class="fas fa-envelope" aria-hidden="true"></i> Email
                        </button>
                        <button class="btn btn-outline action-btn" aria-label="Envoyer le ticket par SMS">
                            <i class="fas fa-mobile-alt" aria-hidden="true"></i> SMS
                        </button>
                    </div>

                    <!-- Payment Success Panel -->
                     <div class="payment-success-panel">
                         <div class="payment-success-title">
                            <i class="fas fa-check-circle" aria-hidden="true"></i>
                            Paiement réussi!
                         </div>
                         <div class="payment-success-message">
                            La table <span class="receipt-table-num">3</span> est maintenant marquée comme libre et prête pour les prochains clients.
                         </div>
                         <div class="modal-actions" style="margin-top: 1rem;">
                             <button class="btn btn-outline" id="clean-table-btn">
                                 <i class="fas fa-broom" aria-hidden="true"></i> Marquer comme nettoyée
                             </button>
                             <button class="btn btn-secondary" id="back-to-tables-btn"> <!-- Changed to secondary -->
                                 <i class="fas fa-th-large" aria-hidden="true"></i> Retour aux tables
                             </button>
                         </div>
                     </div>
                </div> <!-- End Receipt Container -->
            </div>

            <!-- Stats Tab Content -->
            <div id="stats-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-stats" hidden>
                <div class="payment-summary">
                    <div class="summary-title"><i class="fas fa-calendar-day" aria-hidden="true"></i> Statistiques du Jour</div>
                    <div class="subtotal-row"><div class="subtotal-label">Tables servies</div><div class="subtotal-value">12</div></div>
                    <div class="subtotal-row"><div class="subtotal-label">Clients servis</div><div class="subtotal-value">43</div></div>
                    <div class="subtotal-row"><div class="subtotal-label">Chiffre d'affaires</div><div class="subtotal-value">678,50€</div></div>
                    <div class="subtotal-row"><div class="subtotal-label">Ticket moyen</div><div class="subtotal-value">56,54€</div></div>
                    <div class="subtotal-row"><div class="subtotal-label">Pourboires estimés</div><div class="subtotal-value">32,70€</div></div>
                </div>

                <div class="payment-summary">
                    <div class="summary-title"><i class="fas fa-tachometer-alt" aria-hidden="true"></i> Performance Personnelle</div>
                    <div style="margin-bottom: 1rem;">
                        <div class="subtotal-row">
                            <div class="subtotal-label">Temps moyen prise de commande</div>
                            <div class="subtotal-value">2.1 min <span style="color: var(--success);">(Rapide)</span></div>
                        </div>
                        <div class="progress-bar-container" aria-label="Performance Temps de commande, 90%">
                            <div class="progress-bar" style="width: 90%; background-color: var(--success);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div class="subtotal-row">
                            <div class="subtotal-label">Satisfaction client (avis récents)</div>
                            <div class="subtotal-value">4.7 / 5 <i class="fas fa-star" style="color: var(--warning);"></i></div>
                        </div>
                         <div class="progress-bar-container" aria-label="Satisfaction client, 94%">
                            <div class="progress-bar" style="width: 94%; background-color: var(--primary);"></div>
                        </div>
                    </div>
                    <div>
                        <div class="subtotal-row">
                            <div class="subtotal-label">Ventes additionnelles (Menu / Suggestions)</div>
                             <div class="subtotal-value">15% <span style="color: var(--secondary);">(Bon)</span></div>
                        </div>
                         <div class="progress-bar-container" aria-label="Performance Ventes additionnelles, 75%">
                             <div class="progress-bar" style="width: 75%; background-color: var(--secondary);"></div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Stats Tab -->
        </div> <!-- End Main Content -->

        <!-- Cart Panel -->
        <div class="cart" id="cart-panel" aria-labelledby="cart-heading">
            <div class="cart-header" role="button" aria-expanded="false" aria-controls="cart-details">
                 <div class="cart-handle" aria-hidden="true"></div>
                 <div class="cart-summary">
                    <div>
                        <span class="cart-title" id="cart-heading">Table <span class="cart-table-id">N/A</span></span>
                        <span class="cart-count">(0 articles)</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="cart-total">0,00€</span>
                        <button class="cart-toggle-btn" aria-label="Afficher/Masquer le détail du panier">
                            <i class="fas fa-chevron-up" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>

             <div id="cart-details"> <!-- Content revealed when expanded -->
                <div class="cart-content">
                    <!-- Cart items will be added here by JS -->
                    <div class="cart-empty-message" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <p>Le panier est vide.</p>
                    </div>
                </div>

                <div class="cart-footer">
                    <div class="subtotal-row">
                        <span class="subtotal-label">Sous-total</span>
                        <span class="subtotal-value cart-subtotal-footer">0,00€</span>
                    </div>
                    <div class="subtotal-row">
                        <span class="subtotal-label">TVA (10%)</span>
                        <span class="subtotal-value cart-tax-footer">0,00€</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">Total</span>
                        <span class="total-value cart-grand-total-footer">0,00€</span>
                    </div>
                    <div class="cart-actions">
                        <button class="btn btn-outline" id="cancel-order-btn">
                            <i class="fas fa-trash-alt" aria-hidden="true"></i> Annuler
                        </button>
                        <button class="btn btn-primary" id="send-to-kitchen-btn">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i> Envoyer
                        </button>
                         <button class="btn btn-secondary" id="go-to-payment-btn" style="grid-column: 1 / -1; margin-top: var(--spacing-sm);">
                            <i class="fas fa-credit-card" aria-hidden="true"></i> Aller au Paiement
                        </button>
                    </div>
                </div>
            </div> <!-- End Cart Details -->
        </div> <!-- End Cart Panel -->

        <!-- Item Customization Modal -->
        <div class="modal-overlay" id="customization-overlay">
            <div class="modal" id="customization-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-label">
                 <div class="modal-header">
                    <h3 class="modal-title" id="modal-title-label">Personnaliser l'article</h3>
                    <button class="modal-close" aria-label="Fermer la fenêtre de personnalisation">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Dynamic content will be loaded here -->
                    <div class="option-section">
                        <h4 class="option-title">Cuisson</h4>
                        <div class="option-grid" role="radiogroup" aria-labelledby="cooking-level-label">
                            <div id="cooking-level-label" class="visually-hidden">Choisir la cuisson</div>
                            <button class="option-item" role="radio" aria-checked="false" data-option="Bleu">Bleu</button>
                            <button class="option-item active" role="radio" aria-checked="true" data-option="Saignant">Saignant</button>
                            <button class="option-item" role="radio" aria-checked="false" data-option="À point">À point</button>
                            <button class="option-item" role="radio" aria-checked="false" data-option="Bien cuit">Bien cuit</button>
                        </div>
                    </div>

                    <div class="option-section">
                        <h4 class="option-title">Accompagnement</h4>
                         <div class="option-grid" role="radiogroup" aria-labelledby="side-dish-label">
                            <div id="side-dish-label" class="visually-hidden">Choisir l'accompagnement</div>
                            <button class="option-item active" role="radio" aria-checked="true" data-option="Frites">Frites</button>
                            <button class="option-item" role="radio" aria-checked="false" data-option="Légumes">Légumes</button>
                            <button class="option-item" role="radio" aria-checked="false" data-option="Purée">Purée</button>
                            <button class="option-item" role="radio" aria-checked="false" data-option="Gratin">Gratin</button>
                        </div>
                    </div>

                    <div class="option-section">
                        <h4 class="option-title">Extras</h4>
                        <div class="extras-list" role="group" aria-labelledby="extras-label">
                             <div id="extras-label" class="visually-hidden">Choisir les extras</div>
                             <label class="extra-item" role="checkbox" aria-checked="false" tabindex="0">
                                <div class="extra-label">
                                    <div class="checkbox" aria-hidden="true"></div>
                                    <span>Sauce béarnaise</span>
                                </div>
                                <div class="extra-price">+2,50€</div>
                             </label>
                             <label class="extra-item" role="checkbox" aria-checked="false" tabindex="0">
                                <div class="extra-label">
                                    <div class="checkbox" aria-hidden="true"></div>
                                    <span>Supplément frites</span>
                                </div>
                                <div class="extra-price">+3,00€</div>
                            </label>
                             <label class="extra-item" role="checkbox" aria-checked="true" tabindex="0">
                                <div class="extra-label">
                                    <div class="checkbox checked" aria-hidden="true"></div>
                                    <span>Sans sel</span>
                                </div>
                                <div class="extra-price"></div> <!-- No price -->
                            </label>
                        </div>
                    </div>

                    <div class="option-section">
                        <h4 class="option-title" id="notes-label">Notes spéciales</h4>
                        <textarea class="notes-field" placeholder="Allergies, instructions spéciales..." aria-labelledby="notes-label"></textarea>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-outline modal-cancel-btn">Annuler</button>
                    <button class="btn btn-primary add-to-cart-btn">
                        <i class="fas fa-plus" aria-hidden="true"></i> Ajouter à la commande
                    </button>
                </div>
            </div>
        </div> <!-- End Modal -->

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" role="navigation" aria-label="Navigation inférieure">
            <a href="#" class="bottom-nav-item" data-tab="tables" role="tab" aria-selected="true" aria-controls="tables-tab">
                <i class="fas fa-th-large bottom-nav-icon" aria-hidden="true"></i>
                <span class="bottom-nav-label">Tables</span>
            </a>
            <a href="#" class="bottom-nav-item" data-tab="orders" role="tab" aria-selected="false" aria-controls="orders-tab" tabindex="-1">
                <i class="fas fa-utensils bottom-nav-icon" aria-hidden="true"></i>
                 <span class="bottom-nav-label">Commande</span>
            </a>
            <a href="#" class="bottom-nav-item" data-tab="payment" role="tab" aria-selected="false" aria-controls="payment-tab" tabindex="-1">
                <i class="fas fa-cash-register bottom-nav-icon" aria-hidden="true"></i>
                 <span class="bottom-nav-label">Paiement</span>
            </a>
            <a href="#" class="bottom-nav-item" data-tab="receipt" role="tab" aria-selected="false" aria-controls="receipt-tab" tabindex="-1">
                <i class="fas fa-receipt bottom-nav-icon" aria-hidden="true"></i>
                 <span class="bottom-nav-label">Tickets</span>
            </a>
            <a href="#" class="bottom-nav-item" data-tab="stats" role="tab" aria-selected="false" aria-controls="stats-tab" tabindex="-1">
                <div style="position: relative;">
                    <i class="fas fa-chart-line bottom-nav-icon" aria-hidden="true"></i>
                    <!-- Badge can be added dynamically if needed -->
                    <!-- <span class="bottom-nav-badge">3</span> -->
                </div>
                 <span class="bottom-nav-label">Stats</span>
            </a>
        </nav>

        <!-- Toast Notification Container -->
        <div class="toast-container" aria-live="assertive" aria-atomic="true">
             <!-- Toasts will be added here by JS -->
        </div>

    </div> <!-- End App Container -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const body = document.body;
            const datetimeElement = document.querySelector('.datetime');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            const tableItems = document.querySelectorAll('.table-item');
            const backToTablesBtn = document.getElementById('back-to-tables');
            const menuItems = document.querySelectorAll('.menu-item');
            const customizationOverlay = document.getElementById('customization-overlay');
            const customizationModal = document.getElementById('customization-modal');
            const modalCloseBtn = customizationModal.querySelector('.modal-close');
            const modalCancelBtn = customizationModal.querySelector('.modal-cancel-btn');
            const modalAddToCartBtn = customizationModal.querySelector('.add-to-cart-btn');
            const modalTitle = customizationModal.querySelector('.modal-title');
            const modalBody = customizationModal.querySelector('.modal-body'); // To load dynamic content
            const cartPanel = document.getElementById('cart-panel');
            const cartHeader = cartPanel.querySelector('.cart-header');
            const cartDetails = document.getElementById('cart-details');
            const cartContent = cartPanel.querySelector('.cart-content');
            const cartEmptyMessage = cartPanel.querySelector('.cart-empty-message');
            const cartTableIdSpan = cartPanel.querySelector('.cart-table-id');
            const cartItemCountSpan = cartPanel.querySelector('.cart-count');
            const cartTotalSpan = cartPanel.querySelector('.cart-total');
            const cartSubtotalFooterSpan = cartPanel.querySelector('.cart-subtotal-footer');
            const cartTaxFooterSpan = cartPanel.querySelector('.cart-tax-footer');
            const cartGrandTotalFooterSpan = cartPanel.querySelector('.cart-grand-total-footer');
            const sendToKitchenBtn = document.getElementById('send-to-kitchen-btn');
            const cancelOrderBtn = document.getElementById('cancel-order-btn');
            const goToPaymentBtn = document.getElementById('go-to-payment-btn');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const contrastToggleBtn = document.getElementById('contrast-toggle');
            const toastContainer = document.querySelector('.toast-container');
            const searchInput = document.querySelector('.search-input');
            const voiceBtn = document.querySelector('.voice-btn');
            const categoryTabs = document.querySelectorAll('.categories .category');
            const paymentMethods = document.querySelectorAll('.payment-method');
            const cashPaymentDetails = document.querySelector('.cash-payment-details'); // Assuming cash only for now
            const amountInput = document.querySelector('.amount-input');
            const numpadKeys = document.querySelectorAll('.numpad .numkey');
            const changeAmountSpan = document.querySelector('.change-amount');
            const billsDisplay = document.querySelector('.bills-display');
            const tipCheckbox = document.getElementById('round-tip');
            const tipAmountSpan = document.querySelector('.tip-amount');
            const completePaymentBtn = document.getElementById('complete-payment');
            const backToTablesReceiptBtn = document.getElementById('back-to-tables-btn');
            const cleanTableBtn = document.getElementById('clean-table-btn');

            // --- State ---
            let currentTable = null;
            let currentOrder = []; // Array of {id, name, price, qty, options: [], notes: ''}
            let currentTab = 'tables';
            const TAX_RATE = 0.10; // 10%

            // --- Utility Functions ---
            const formatCurrency = (value) => {
                // Ensure value is a number before formatting
                const numberValue = Number(value);
                 if (isNaN(numberValue)) {
                     console.error("Invalid value passed to formatCurrency:", value);
                     return "0,00 €"; // Or some default/error value
                 }
                return numberValue.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            };

            const showToast = (message, type = 'info', duration = 3000) => {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.setAttribute('role', 'status');
                let iconClass = 'fa-info-circle';
                if (type === 'success') iconClass = 'fa-check-circle';
                if (type === 'error') iconClass = 'fa-exclamation-triangle';

                toast.innerHTML = `<i class="fas ${iconClass}" aria-hidden="true"></i> ${message}`;
                toastContainer.appendChild(toast);

                // Trigger animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Remove after duration
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                         if (toast.parentNode === toastContainer) { // Check if still attached
                             toast.remove();
                         }
                    }, 300); // Wait for transition
                }, duration);
            };

             const vibrate = (pattern) => {
                if ('vibrate' in navigator) {
                    try {
                        navigator.vibrate(pattern);
                    } catch (e) {
                        console.warn("Haptic feedback failed:", e);
                    }
                }
            };


            // --- Core Logic ---

            // Date/Time Update
            function updateDateTime() {
                if (datetimeElement) {
                    const now = new Date();
                    // Format: YYYY-MM-DD HH:MM:SS
                    const pad = (n) => n.toString().padStart(2, '0');
                    const formattedDate = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
                    datetimeElement.textContent = formattedDate;

                     // Update receipt time if visible
                     const receiptTime = document.querySelector('.receipt-datetime');
                     const receiptTab = document.getElementById('receipt-tab');
                     if(receiptTime && receiptTab && !receiptTab.hidden) { // Check if tab is not hidden
                         receiptTime.textContent = formattedDate;
                     }
                }
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);


            // Tab Navigation
            function activateTab(tabId) {
                currentTab = tabId;
                // Update Top Tabs
                tabs.forEach(tab => {
                    const isSelected = tab.getAttribute('data-tab') === tabId;
                    tab.setAttribute('aria-selected', isSelected);
                    tab.setAttribute('tabindex', isSelected ? '0' : '-1');
                    tab.classList.toggle('active', isSelected); // Keep class for styling ease
                });
                // Update Bottom Nav
                bottomNavItems.forEach(item => {
                    const isSelected = item.getAttribute('data-tab') === tabId;
                    item.setAttribute('aria-selected', isSelected);
                    item.setAttribute('tabindex', isSelected ? '0' : '-1');
                     item.classList.toggle('active', isSelected); // Keep class for styling ease
                });
                // Update Content Panels
                tabContents.forEach(content => {
                    const contentId = content.id.replace('-tab', '');
                    const isHidden = contentId !== tabId;
                    content.hidden = isHidden;
                    // content.setAttribute('aria-hidden', isHidden); // Use hidden attribute directly
                });

                 // Show/Hide Cart based on tab
                 const cartVisible = (tabId === 'orders' || tabId === 'payment') && currentTable !== null;
                 cartPanel.style.display = cartVisible ? 'flex' : 'none';

                 // Focus the first focusable element in the new tab for accessibility
                 const newTabContent = document.getElementById(`${tabId}-tab`);
                 if(newTabContent && !newTabContent.hidden) {
                     const firstFocusable = newTabContent.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                     if(firstFocusable) {
                        //  firstFocusable.focus(); // Sometimes jarring, use with caution
                     }
                 }
            }

            tabs.forEach(tab => tab.addEventListener('click', () => activateTab(tab.getAttribute('data-tab'))));
            bottomNavItems.forEach(item => item.addEventListener('click', (e) => {
                e.preventDefault();
                activateTab(item.getAttribute('data-tab'));
            }));


            // Table Selection
            tableItems.forEach(table => {
                table.addEventListener('click', () => {
                    // Prevent selecting if already processing payment for this table? (optional)
                    currentTable = table.getAttribute('data-table');
                    // TODO: Load existing order for this table if applicable
                    // For demo, we reset the order each time
                    currentOrder = [];
                    updateOrderHeader();
                    updateCart(); // This will show the cart now
                    activateTab('orders');
                    showToast(`Table ${currentTable} sélectionnée`);
                    vibrate(50);
                });
                 // Keyboard activation
                 table.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault();
                         table.click();
                     }
                 });
            });

             function updateOrderHeader() {
                const orderHeaderNum = document.querySelector('.table-number-info');
                const orderHeaderMeta = document.querySelector('.table-meta');
                if (currentTable !== null) {
                    const tableElement = document.querySelector(`.table-item[data-table="${currentTable}"]`);
                    const capacityElement = tableElement?.querySelector('.table-capacity');
                    const timeElement = tableElement?.querySelector('.table-time');
                    const capacity = capacityElement?.textContent.replace('<i class="fas fa-users" aria-hidden="true"></i>','').trim() || '?';
                    const time = timeElement?.textContent.replace(/<i.*?><\/i>\s*/, '').trim() || ''; // Remove potential icon tag
                    const status = tableElement?.classList.contains('table-free') ? 'Libre' :
                                   tableElement?.classList.contains('table-occupied') ? 'Occupée' :
                                   tableElement?.classList.contains('table-reserved') ? 'Réservée' : '';
                    const timeIconClass = status === 'Réservée' ? 'fas fa-calendar-alt' : 'fas fa-clock';


                    orderHeaderNum.textContent = `Table ${currentTable}`;
                    let metaHTML = `<span><i class="fas fa-users" aria-hidden="true"></i> ${capacity} pers.</span>`; // Add 'pers.'
                    if (time) metaHTML += `<span><i class="${timeIconClass}" aria-hidden="true"></i> ${time}</span>`;
                    metaHTML += `<span class="history-link"><i class="fas fa-history" aria-hidden="true"></i> Historique</span>`;
                    orderHeaderMeta.innerHTML = metaHTML;
                } else {
                    orderHeaderNum.textContent = 'Sélectionner une table';
                    orderHeaderMeta.innerHTML = '';
                }
            }

            backToTablesBtn.addEventListener('click', () => activateTab('tables'));


            // Menu Item Interaction -> Open Modal
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                     if (currentTable === null) {
                        showToast('Veuillez d\'abord sélectionner une table.', 'warning');
                        vibrate([50,50]);
                        return;
                     }

                    const itemId = item.dataset.id;
                    const itemName = item.dataset.name;
                    const itemPrice = parseFloat(item.dataset.price);

                    // TODO: Load actual customization options based on itemId
                    modalTitle.textContent = itemName;
                    // Example: Reset/Load static options for now
                    // modalBody.innerHTML = `... load options for ${itemName} ...`;
                     customizationModal.querySelectorAll('.option-item.active').forEach(el => el.classList.remove('active'));
                     customizationModal.querySelectorAll('.extra-item[aria-checked="true"]').forEach(el => {
                        el.setAttribute('aria-checked', 'false');
                        el.querySelector('.checkbox').classList.remove('checked');
                     });
                    customizationModal.querySelector('.notes-field').value = '';


                    // Store item data for adding to cart
                    modalAddToCartBtn.dataset.itemId = itemId;
                    modalAddToCartBtn.dataset.itemName = itemName;
                    modalAddToCartBtn.dataset.itemPrice = itemPrice;

                    customizationOverlay.classList.add('active');
                    customizationModal.classList.add('active');
                    customizationModal.querySelector('button, input, textarea, select, [role="radio"], [role="checkbox"]')?.focus(); // Focus first element in modal
                    vibrate(50);
                });
                 // Keyboard activation
                 item.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault();
                         item.click();
                     }
                 });
            });

            // Modal Closing
            const closeModal = () => {
                customizationOverlay.classList.remove('active');
                customizationModal.classList.remove('active');
                // TODO: Return focus to the element that opened the modal if possible
            };
            modalCloseBtn.addEventListener('click', closeModal);
            modalCancelBtn.addEventListener('click', closeModal);
            customizationOverlay.addEventListener('click', (e) => {
                if (e.target === customizationOverlay) {
                    closeModal();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && customizationOverlay.classList.contains('active')) {
                    closeModal();
                }
            });

             // Modal Option Selection (Example for radio groups and checkboxes)
            customizationModal.addEventListener('click', (e) => {
                // Radio buttons (like cooking level, side dish)
                const radioTarget = e.target.closest('.option-item[role="radio"]');
                if (radioTarget) {
                    const group = radioTarget.closest('.option-grid');
                    group.querySelectorAll('.option-item[role="radio"]').forEach(radio => {
                        const isSelected = radio === radioTarget;
                        radio.classList.toggle('active', isSelected);
                        radio.setAttribute('aria-checked', isSelected);
                    });
                     vibrate(30);
                     return; // Prevent checkbox logic from running
                }
                // Checkboxes (like extras)
                const checkboxLabel = e.target.closest('.extra-item[role="checkbox"]');
                if (checkboxLabel) {
                    const checkboxInput = checkboxLabel.querySelector('.checkbox'); // The visual div
                    const isChecked = checkboxLabel.getAttribute('aria-checked') === 'true';
                    checkboxLabel.setAttribute('aria-checked', !isChecked);
                    checkboxInput.classList.toggle('checked', !isChecked);
                    vibrate(30);
                }
            });
             // Keyboard activation for modal options
             customizationModal.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                      const radioTarget = e.target.closest('.option-item[role="radio"]');
                       const checkboxLabel = e.target.closest('.extra-item[role="checkbox"]');
                       if(radioTarget || checkboxLabel) {
                            e.preventDefault(); // Prevent default space bar scroll
                            e.target.click(); // Simulate click
                       }
                 }
             });


            // Add to Cart from Modal
            modalAddToCartBtn.addEventListener('click', () => {
                const itemId = modalAddToCartBtn.dataset.itemId;
                const itemName = modalAddToCartBtn.dataset.itemName;
                const itemPrice = parseFloat(modalAddToCartBtn.dataset.itemPrice);

                // Gather selected options and notes from modal
                const selectedOptions = [];
                customizationModal.querySelectorAll('.option-item.active[role="radio"]').forEach(opt => selectedOptions.push(opt.dataset.option));
                customizationModal.querySelectorAll('.extra-item[aria-checked="true"]').forEach(opt => {
                    const label = opt.querySelector('.extra-label span').textContent;
                    const priceText = opt.querySelector('.extra-price').textContent;
                    selectedOptions.push(label + (priceText ? ` (${priceText})` : ''));
                    // TODO: Add extra price to itemPrice if applicable
                });
                const notes = customizationModal.querySelector('.notes-field').value.trim();

                // Check if item already exists with same options/notes (simple check)
                 const generateItemKey = (item) => `${item.id}-${JSON.stringify(item.options.sort())}-${item.notes}`;
                 const newItemKey = generateItemKey({ id: itemId, options: selectedOptions, notes: notes });

                const existingItemIndex = currentOrder.findIndex(item => generateItemKey(item) === newItemKey);

                if (existingItemIndex > -1) {
                    currentOrder[existingItemIndex].qty++;
                } else {
                     currentOrder.push({
                        id: itemId,
                        name: itemName,
                        price: itemPrice, // Base price, adjust if extras have cost
                        qty: 1,
                        options: selectedOptions,
                        notes: notes
                    });
                }

                updateCart();
                closeModal();
                showToast(`${itemName} ajouté`, 'success');
                 if (!cartPanel.classList.contains('expanded')) { // Expand cart if collapsed
                     cartHeader.click();
                 }
                vibrate([30, 50, 30]); // Haptic feedback for success
            });

            // Cart Update & Rendering
            function updateCart() {
                if (currentTable === null) {
                    cartPanel.style.display = 'none';
                    return;
                }
                cartPanel.style.display = 'flex'; // Ensure visible if table selected

                const totalItems = currentOrder.reduce((sum, item) => sum + item.qty, 0);
                cartTableIdSpan.textContent = currentTable || 'N/A';
                cartItemCountSpan.textContent = `(${totalItems} article${totalItems !== 1 ? 's' : ''})`; // Pluralize

                cartContent.innerHTML = ''; // Clear previous items

                if (currentOrder.length === 0) {
                     if (!cartContent.contains(cartEmptyMessage)) { // Add only if not present
                        cartContent.appendChild(cartEmptyMessage);
                     }
                } else {
                     if(cartContent.contains(cartEmptyMessage)) {
                         cartEmptyMessage.remove(); // Remove if present
                     }
                     currentOrder.forEach((item, index) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'cart-item';
                        itemElement.innerHTML = `
                            <div class="cart-item-details">
                                <div class="cart-item-title">${item.name}</div>
                                ${item.options.length > 0 ? `<div class="cart-item-options">${item.options.map(o => o.replace(/ \([^)]*\)/, '')).join(', ')}</div>` : ''} <!-- Show options without prices -->
                                ${item.notes ? `<div class="cart-item-options" style="font-style: italic;">Note: ${item.notes}</div>` : ''}
                                <div class="cart-item-price">${formatCurrency(item.price)}</div>
                            </div>
                            <div class="cart-item-actions">
                                <button class="qty-btn qty-decrease" data-index="${index}" aria-label="Diminuer quantité de ${item.name}">-</button>
                                <span class="qty-value" aria-live="polite" aria-atomic="true" aria-label="Quantité: ${item.qty}">${item.qty}</span>
                                <button class="qty-btn qty-increase" data-index="${index}" aria-label="Augmenter quantité de ${item.name}">+</button>
                            </div>
                        `;
                        cartContent.appendChild(itemElement);
                    });
                }

                // Calculate totals
                const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const tax = subtotal * TAX_RATE;
                const total = subtotal + tax;

                cartTotalSpan.textContent = formatCurrency(total);
                cartSubtotalFooterSpan.textContent = formatCurrency(subtotal);
                cartTaxFooterSpan.textContent = formatCurrency(tax);
                cartGrandTotalFooterSpan.textContent = formatCurrency(total);

                 // Update payment summary if payment tab is active
                 const paymentTab = document.getElementById('payment-tab');
                 if (paymentTab && !paymentTab.hidden) {
                    document.querySelector('.cart-item-count').textContent = totalItems;
                    document.querySelector('.cart-subtotal').textContent = formatCurrency(subtotal);
                    document.querySelector('.cart-tax').textContent = formatCurrency(tax);
                    document.querySelector('.cart-grand-total').textContent = formatCurrency(total);
                    document.querySelector('.table-number-payment').textContent = `(Table ${currentTable})`;
                 }

                 // Enable/disable cart buttons
                 const hasItems = currentOrder.length > 0;
                 sendToKitchenBtn.disabled = !hasItems;
                 cancelOrderBtn.disabled = !hasItems;
                 goToPaymentBtn.disabled = !hasItems; // Or based on if order was sent
            }

            // Cart Quantity Adjustment
            cartContent.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.qty-btn');
                if (!targetButton) return;

                const index = targetButton.dataset.index;
                if (index === undefined) return;

                const itemIndex = parseInt(index);
                 if(isNaN(itemIndex) || !currentOrder[itemIndex]) return; // Safety check

                if (targetButton.classList.contains('qty-increase')) {
                    currentOrder[itemIndex].qty++;
                     vibrate(30);
                } else if (targetButton.classList.contains('qty-decrease')) {
                    currentOrder[itemIndex].qty--;
                    if (currentOrder[itemIndex].qty <= 0) {
                        const removedItemName = currentOrder[itemIndex].name;
                        currentOrder.splice(itemIndex, 1); // Remove item if qty is 0 or less
                        showToast(`${removedItemName} supprimé`);
                    }
                     vibrate(30);
                }
                updateCart(); // Re-render the cart
            });

            // Cart Expand/Collapse
            cartHeader.addEventListener('click', () => {
                const isExpanded = cartPanel.classList.toggle('expanded');
                cartHeader.setAttribute('aria-expanded', isExpanded);
                 cartDetails.hidden = !isExpanded; // Toggle visibility of details
                 cartHeader.querySelector('.fa-chevron-up').style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
            });


             // Cart Actions
            cancelOrderBtn.addEventListener('click', () => {
                if (currentOrder.length > 0 && confirm(`Voulez-vous vraiment vider le panier pour la table ${currentTable} ?`)) {
                    currentOrder = [];
                    updateCart();
                    showToast('Panier vidé', 'warning');
                     vibrate(50);
                }
            });

            sendToKitchenBtn.addEventListener('click', () => {
                 if (currentOrder.length === 0) return;
                 // TODO: Implement actual sending logic (API call)
                 console.log(`Sending order for Table ${currentTable}:`, JSON.stringify(currentOrder));
                 showToast(`Commande pour Table ${currentTable} envoyée !`, 'success');
                 // Maybe disable items or show a "sent" status
                 // Optionally clear order or mark as sent: currentOrder.forEach(item => item.sent = true); updateCart();
                 vibrate([50, 100, 50]);
            });

             goToPaymentBtn.addEventListener('click', () => {
                 if (currentOrder.length === 0) {
                     showToast('Le panier est vide.', 'warning');
                     return;
                 }
                activateTab('payment');
                updateCart(); // Ensure payment summary totals are up-to-date
            });


            // Theme Toggle
            themeToggleBtn.addEventListener('click', () => {
                const isDark = body.classList.toggle('dark-mode');
                themeToggleBtn.classList.toggle('active', isDark);
                themeToggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                themeToggleBtn.setAttribute('aria-label', isDark ? 'Basculer le thème clair' : 'Basculer le thème sombre');
                localStorage.setItem('dark-mode', isDark ? 'true' : 'false');
                 vibrate(30);
            });
            if (localStorage.getItem('dark-mode') === 'true') {
                body.classList.add('dark-mode');
                themeToggleBtn.classList.add('active');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggleBtn.setAttribute('aria-label', 'Basculer le thème clair');
            }

            // Contrast Toggle
            contrastToggleBtn.addEventListener('click', () => {
                const isHighContrast = body.classList.toggle('high-contrast');
                contrastToggleBtn.classList.toggle('active', isHighContrast);
                 contrastToggleBtn.setAttribute('aria-pressed', isHighContrast);
                localStorage.setItem('high-contrast', isHighContrast ? 'true' : 'false');
                 vibrate(30);
            });
             if (localStorage.getItem('high-contrast') === 'true') {
                body.classList.add('high-contrast');
                contrastToggleBtn.classList.add('active');
                 contrastToggleBtn.setAttribute('aria-pressed', 'true');
            }


            // --- Payment Logic ---
            paymentMethods.forEach(method => {
                method.addEventListener('click', () => {
                    paymentMethods.forEach(m => {
                        const isSelected = m === method;
                        m.classList.toggle('active', isSelected);
                        m.setAttribute('aria-checked', isSelected);
                        m.setAttribute('tabindex', isSelected ? '0' : '-1');
                    });
                    // Show/hide specific payment details based on method.dataset.method
                    const showCash = method.dataset.method === 'cash';
                    cashPaymentDetails.style.display = showCash ? 'block' : 'none';
                     if(showCash) {
                        // Reset cash payment state
                        currentAmountString = "0";
                        amountInput.value = "0,00";
                        changeAmountSpan.textContent = "0,00 €";
                        billsDisplay.innerHTML = '';
                        tipCheckbox.checked = false;
                        amountInput.focus();
                     }
                    // Add logic for other payment methods here...
                    vibrate(30);
                });
                 method.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); method.click(); }
                     // Arrow key navigation within the radio group
                     if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                         const current = paymentMethods.findIndex(m => m === e.target);
                         const nextIndex = e.key === 'ArrowRight' ? (current + 1) % paymentMethods.length : (current - 1 + paymentMethods.length) % paymentMethods.length;
                         paymentMethods[nextIndex].focus();
                         paymentMethods[nextIndex].click(); // Also select it
                     }
                 });
            });

            // Numpad Logic
            let currentAmountString = "0"; // Keep track of cents as string
            numpadKeys.forEach(key => {
                key.addEventListener('click', () => {
                    const value = key.dataset.key;
                     const totalDueText = cartGrandTotalFooterSpan.textContent; // Get total from cart footer
                     const totalDue = parseFloat(totalDueText.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;

                    if (value === 'C') {
                        currentAmountString = "0";
                    } else if (value === '00') {
                        if (currentAmountString !== "0" && currentAmountString.length < 10) { // Limit length
                            currentAmountString += "00";
                        }
                    } else {
                         if (currentAmountString === "0") {
                            currentAmountString = value;
                         } else if (currentAmountString.length < 10) { // Limit length
                            currentAmountString += value;
                        }
                    }

                    // Handle value as cents, then format
                    let amountInCents = parseInt(currentAmountString);
                    if(isNaN(amountInCents)) amountInCents = 0;

                    const formattedAmount = (amountInCents / 100).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    amountInput.value = formattedAmount;

                     // Calculate and update change
                    const change = (amountInCents / 100) - totalDue;
                    if (change >= 0) {
                        changeAmountSpan.textContent = formatCurrency(change);
                        tipAmountSpan.textContent = formatCurrency(change); // Update potential tip amount
                        updateBillsDisplay(change);
                    } else {
                         changeAmountSpan.textContent = formatCurrency(0);
                         tipAmountSpan.textContent = formatCurrency(0);
                         billsDisplay.innerHTML = ''; // No change
                    }
                    vibrate(30);
                });
            });

             // Function to display change breakdown (basic example)
            function updateBillsDisplay(changeAmount) {
                billsDisplay.innerHTML = ''; // Clear existing
                if (changeAmount <= 0.001) return; // Account for floating point issues

                const denominations = [50, 20, 10, 5, 2, 1, 0.5, 0.2, 0.1, 0.05, 0.02, 0.01];
                let remaining = changeAmount;

                denominations.forEach(denom => {
                     // Use a tolerance for floating point comparisons
                    if (remaining >= denom - 0.001) {
                        const count = Math.floor(remaining / denom + 0.001); // Add tolerance
                        for(let i = 0; i < count; i++) {
                            const billElement = document.createElement('div');
                            billElement.className = denom >= 1 ? 'bill' : 'coin';
                            billElement.textContent = denom >= 0.05 ? formatCurrency(denom).replace(/\s/g,'') : `${Math.round(denom*100)}c`; // Use formatCurrency or cents
                             billElement.setAttribute('aria-label', formatCurrency(denom)); // Improve label
                            billsDisplay.appendChild(billElement);
                        }
                        remaining = parseFloat((remaining - count * denom).toFixed(2)); // Use toFixed for precision
                    }
                });
            }

             // Complete Payment
            completePaymentBtn.addEventListener('click', () => {
                 const totalDueText = cartGrandTotalFooterSpan.textContent;
                 const totalDue = parseFloat(totalDueText.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;
                 const amountPaidText = amountInput.value;
                 const amountPaid = parseFloat(amountPaidText.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;
                 const selectedMethodElement = document.querySelector('.payment-method.active');
                 const paymentMethod = selectedMethodElement ? selectedMethodElement.dataset.method : 'unknown';
                 let changeGiven = 0;

                 if (paymentMethod === 'cash') {
                     if (amountPaid < totalDue) {
                         showToast('Montant payé insuffisant!', 'error');
                         vibrate([100, 50, 100]); // Error vibration
                         amountInput.focus();
                         return;
                     }
                     changeGiven = amountPaid - totalDue;
                 } else if (paymentMethod === 'card' || paymentMethod === 'mobile') {
                     // For card/mobile, assume exact amount is paid unless splitting
                     // Amount input might not be relevant here or used differently
                 } else if (paymentMethod === 'split') {
                     // TODO: Implement split payment logic
                     showToast('Le paiement partagé n\'est pas encore implémenté.', 'info');
                     return;
                 } else {
                     showToast('Veuillez sélectionner un mode de paiement.', 'warning');
                     return;
                 }


                 // TODO: Record payment details (tableId, order, method, amount, change, tip)
                 console.log(`Payment Recorded: Table ${currentTable}, Method: ${paymentMethod}, Total: ${formatCurrency(totalDue)}, Paid: ${formatCurrency(amountPaid)}, Change: ${formatCurrency(changeGiven)}`);


                 // --- Update Receipt Tab Content ---
                 const receiptTabElement = document.getElementById('receipt-tab');
                 // Update Receipt Header
                 receiptTabElement.querySelector('.receipt-table-num').textContent = currentTable;
                 receiptTabElement.querySelector('.receipt-datetime').textContent = new Date().toLocaleString('fr-FR'); // Current time
                 // Update Receipt Items
                 const receiptItemsContainer = receiptTabElement.querySelector('.receipt-items');
                 receiptItemsContainer.innerHTML = ''; // Clear old items
                 currentOrder.forEach(item => {
                     const receiptItemEl = document.createElement('div');
                     receiptItemEl.className = 'receipt-item';
                     receiptItemEl.innerHTML = `
                        <div class="item-qty">${item.qty}x</div>
                        <div class="item-name">${item.name} ${item.options.length > 0 ? '<small>('+item.options.map(o => o.replace(/ \([^)]*\)/, '')).join(', ')+')</small>' : ''} ${item.notes ? '<small><i>Note: '+item.notes+'</i></small>' : ''}</div>
                        <div class="item-price">${formatCurrency(item.price * item.qty)}</div>
                     `;
                     receiptItemsContainer.appendChild(receiptItemEl);
                 });
                 // Update Receipt Totals
                 const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.qty), 0);
                 const tax = subtotal * TAX_RATE;
                 receiptTabElement.querySelector('.receipt-subtotal-val').textContent = formatCurrency(subtotal);
                 receiptTabElement.querySelector('.receipt-tax-val').textContent = formatCurrency(tax);
                 receiptTabElement.querySelector('.receipt-total-val').textContent = formatCurrency(totalDue);
                 // Update Payment Details on Receipt
                 const paymentDetailsElements = receiptTabElement.querySelectorAll('.receipt-payment-details');
                 if (paymentDetailsElements.length >= 2) {
                     paymentDetailsElements[0].querySelector('.item-name').textContent = `Payé (${selectedMethodElement.querySelector('.payment-name').textContent}):`;
                     paymentDetailsElements[0].querySelector('.item-price').textContent = formatCurrency(amountPaid);
                     if (paymentMethod === 'cash' && changeGiven > 0.001) {
                        paymentDetailsElements[1].querySelector('.item-name').textContent = 'Rendu:';
                        paymentDetailsElements[1].querySelector('.item-price').textContent = formatCurrency(changeGiven);
                        paymentDetailsElements[1].style.display = 'grid';
                     } else {
                         paymentDetailsElements[1].style.display = 'none'; // Hide change line if not cash or no change
                     }
                 }
                 // Update Success Panel Table Number
                 receiptTabElement.querySelector('.payment-success-panel .receipt-table-num').textContent = currentTable;
                 // --- End Update Receipt Tab ---


                 activateTab('receipt'); // Show the receipt
                 showToast(`Paiement pour Table ${currentTable} enregistré`, 'success');
                 vibrate([50, 100, 50]);

                 // Mark table as free (example)
                 const tableElement = document.querySelector(`.table-item[data-table="${currentTable}"]`);
                 if(tableElement) {
                     tableElement.classList.remove('table-occupied', 'table-reserved', 'table-urgent');
                     tableElement.classList.add('table-free');
                     const timeDisplay = tableElement.querySelector('.table-time');
                     if (timeDisplay) timeDisplay.remove(); // Remove time display
                     const capacityText = tableElement.querySelector('.table-capacity')?.textContent.replace('<i class="fas fa-users" aria-hidden="true"></i> ','').trim() || '? pers.';
                     tableElement.setAttribute('aria-label', `Table ${currentTable}, ${capacityText}, Libre`);
                 }

                 const paidTableId = currentTable; // Store before clearing
                 currentTable = null; // Clear current table after payment
                 currentOrder = []; // Clear order
                 updateCart(); // Hide cart panel
                 updateOrderHeader(); // Clear order header

                 // Reset payment tab state
                 paymentMethods.forEach(m => m.classList.remove('active'));
                 paymentMethods[0].classList.add('active'); // Default to cash?
                 paymentMethods[0].setAttribute('aria-checked', 'true');
                 paymentMethods[0].setAttribute('tabindex', '0');
                 cashPaymentDetails.style.display = 'block';
                 amountInput.value = '0,00';
                 changeAmountSpan.textContent = '0,00 €';
                 billsDisplay.innerHTML = '';
                 tipCheckbox.checked = false;


            });

             // Back to tables from Receipt
             backToTablesReceiptBtn.addEventListener('click', () => {
                 activateTab('tables');
             });
             cleanTableBtn.addEventListener('click', () => {
                  // TODO: Logic to mark table as cleaned/ready in backend/state
                 showToast(`Table marquée comme nettoyée`, 'info');
                 activateTab('tables');
             });


            // --- Other Initializations ---
            activateTab('tables'); // Start on tables tab
            updateCart(); // Initialize cart state (hidden initially if no table)

             // Filter/Search (Basic examples)
             searchInput.addEventListener('input', (e) => {
                 const searchTerm = e.target.value.toLowerCase().trim();
                 const activeCategory = document.querySelector('.category.active')?.textContent || 'Tous';

                 menuItems.forEach(item => {
                     const name = item.dataset.name.toLowerCase();
                     // TODO: Add actual category filtering logic here
                     const categoryMatch = (activeCategory === 'Tous' /* || itemBelongsToCategory(item, activeCategory) */);
                     const searchMatch = name.includes(searchTerm);

                     item.style.display = (categoryMatch && searchMatch) ? 'flex' : 'none';
                 });
             });

             voiceBtn.addEventListener('click', () => {
                 showToast('Fonction recherche vocale non implémentée');
                 vibrate(100);
                 // TODO: Implement Speech Recognition API if needed
             });

             categoryTabs.forEach(catTab => {
                 catTab.addEventListener('click', () => {
                     categoryTabs.forEach(t => {
                        const isSelected = t === catTab;
                        t.classList.toggle('active', isSelected);
                        t.setAttribute('aria-selected', isSelected);
                     });
                     const category = catTab.textContent;
                     showToast(`Filtre: ${category}`);
                     vibrate(30);
                     // Trigger search input event to re-filter based on new category + existing search term
                     searchInput.dispatchEvent(new Event('input'));
                 });
                 catTab.addEventListener('keydown', (e) => {
                      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); catTab.click(); }
                      // Arrow key navigation
                      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                           const current = Array.from(categoryTabs).findIndex(t => t === e.target);
                           const nextIndex = e.key === 'ArrowRight' ? (current + 1) % categoryTabs.length : (current - 1 + categoryTabs.length) % categoryTabs.length;
                           categoryTabs[nextIndex].focus();
                           categoryTabs[nextIndex].click(); // Also select it
                      }
                 });
             });

        }); // End DOMContentLoaded
    </script>

</body>
</html>
